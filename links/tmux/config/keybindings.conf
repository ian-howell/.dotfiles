# Using Tmux Copy mode:
#
# Enter the copy-mode: prefix [
# Navigate: h, j, k, l, w, W, b, B, {, }
# Search: ?, /
# Start highlight: v
# Yank the highlighted text: Enter
# Paste: prefix ]

###############################################################################
# Key Bindings
###############################################################################
# NOTE: As a general "cleanliness" rule, prefer 'bind' to 'bind-key'

# Unset default prefix
unbind C-b
unbind C-a

# Set Prefix to Ctrl+space
set -g prefix C-space
bind C-space send-prefix

# Create root session
bind-key C-t display-popup -w 80 -h 3 -E -d "#{pane_current_path}" "wt"
bind-key T run-shell "treemux attach-root -d \"$(mktemp -d)\""
# Kubernetes context and namespace switchers
bind-key C run-shell "k8s-context-switcher"
bind-key N run-shell "k8s-namespace-switcher"

# Split panes using \ and - (\ because it doesn't require shift)
# Start in same directory when splitting windows
bind \\ split-window -h -c '#{pane_current_path}'
bind - split-window -v -c '#{pane_current_path}'

# Switch to the most recently used window.
bind C-Space last-window

# When creating a window, start at the same path
bind c new-window -c '#{pane_current_path}' "$SHELL"


# Sane window switching
unbind .
bind m command-prompt -p "Move to index:" "run-shell 'tx-insert-window %%'"

# Use vim keybindings in copy mode
set -g mode-keys vi

# Visual selection toggles (vim-like)
# v: checks #{selection_present}; if set, just turns rectangle mode off so the current range stays, otherwise begins selection
bind -T copy-mode-vi v if-shell -F "#{selection_present}" "send-keys -X rectangle-off" "send-keys -X begin-selection"
# V: if selecting, turns rectangle off, jumps to the other end, snaps that end to start-of-line, jumps back, snaps to end-of-line
# It's a bit buggy, but it's *way* better than the default behavior.
bind -T copy-mode-vi V if-shell -F "#{selection_present}" "send-keys -X rectangle-off \; send-keys -X other-end \; send-keys -X start-of-line \; send-keys -X other-end \; send-keys -X end-of-line" "send-keys -X select-line"
# C-v: if selecting, toggles rectangle via #{rectangle_toggle} without resetting; if not, begins selection then turns rectangle on
bind -T copy-mode-vi C-v if-shell -F "#{selection_present}" "if-shell -F \"#{rectangle_toggle}\" \"send-keys -X rectangle-off\" \"send-keys -X rectangle-on\"" "send-keys -X begin-selection \; send-keys -X rectangle-on"

# Exit copy mode with Escape
bind -T copy-mode-vi Escape send-keys -X cancel

# TODO: revisit this when you work out clipboard shenanigans
# Easier access to the paster-buffer
bind P paste-buffer
# Copy to clipboard
# TODO: old stuff. Compare to the new stuff below
# bind -T copy-mode-vi 'y' send-keys -X copy-pipe "xclip -sel clip -i"
# # Change default behavior of Enter to match 'y'
# bind -T copy-mode-vi Enter send-keys -X copy-pipe "xclip -sel clip -i"
# TODO: this won't work because it's meant for macs...
bind -T copy-mode-vi y send-keys -X copy-pipe 'reattach-to-user-namespace pbcopy'
unbind -T copy-mode-vi Enter
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'reattach-to-user-namespace pbcopy'

# vi-like searching. Prompt first, then enter copy-mode if confirmed, and return to "normal" on escape.
bind / command-prompt -T search -p "(search down)" "copy-mode -e \; send-keys -X search-forward \"%%\""
bind ? command-prompt -T search -p "(search up)" "copy-mode -e \; send-keys -X search-backward \"%%\""

# These (1) switch to copy-mode then (2) scroll up
bind C-y copy-mode \; send-keys -X scroll-up
bind C-u copy-mode \; send-keys -X halfpage-up
bind C-b copy-mode \; send-keys -X page-up

# Fast entry into copy mode
bind -n M-[ copy-mode

# Reload config file
bind r source-file ~/.config/tmux/tmux.conf \; display '~/.config/tmux/tmux.conf sourced'

# Shortcuts to dotfiles

# Quickly detach from session
bind C-d detach

# Prefix-f key table
bind -T prefix f switch-client -T prefix-f
bind -T prefix-f f display-popup -w 50% -h 100% -E -d "#{pane_current_path}" "treemux-folder-picker"
bind -T prefix-f s display-popup -w 80 -h 30 -E -d "#{pane_current_path}" "treemux-session-picker"
bind -T prefix-f g display-popup -w 80 -h 30 -E -d "#{pane_current_path}" "treemux-worktree-picker"
bind -T prefix-f Escape switch-client -T prefix
# Switch to common windows (create if missing)
bind z run-shell "tmux select-window -t 101 2>/dev/null || tmux new-window -t 101 -n zsh -c '#{pane_current_path}' zsh"
bind v run-shell "tmux select-window -t 102 2>/dev/null || tmux new-window -t 102 -n vim -c '#{pane_current_path}' nvim"
bind o run-shell "tmux select-window -t 103 2>/dev/null || tmux new-window -t 103 -n opencode -c '#{pane_current_path}' opencode"
bind g run-shell "tmux select-window -t 104 2>/dev/null || tmux new-window -t 104 -n git -c '#{pane_current_path}' lazygit"
bind k run-shell "tmux select-window -t 105 2>/dev/null || tmux new-window -t 105 -n k9s -c '#{pane_current_path}' k9s"
bind l select-window -t "{last}"
bind L switch-client -l

###############################################################################
# Tmux Nagivator - https://github.com/christoomey/vim-tmux-navigator
###############################################################################

# Check if the current pane is a vim or lazygit pane
# NOTE: There is no lazygit-tmux-navigator plugin, so I won't be able to leave the
# lazygit window, but that's ok because lazygit will generally have a dedicated window.
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
is_lg="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?lazygit$'"
is_fzf="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?fzf$'"

bind -n C-h if-shell "$is_vim || $is_lg || $is_fzf" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim || $is_lg || $is_fzf" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim || $is_lg || $is_fzf" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim || $is_lg || $is_fzf" "send-keys C-l" "select-pane -R"

bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R

###############################################################################
# Popup keymaps
###############################################################################

bind h display-popup -w 90% -h 90% -E -b "rounded" "htop"
