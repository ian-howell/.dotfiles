#!/usr/bin/env bash

set -euo pipefail

SERVER_DIR="${HOME}/.local/share/kanbanflow-mcp-server"

if [ ! -d "$SERVER_DIR" ]; then
  echo "Error: kanbanflow-mcp-server not found at $SERVER_DIR" >&2
  echo "Clone it with: git clone https://github.com/graphyte-labs/kanbanflow-mcp-server.git $SERVER_DIR" >&2
  exit 1
fi

if ! command -v deno >/dev/null 2>&1; then
  echo "Error: deno is not installed" >&2
  echo "Install it with: curl -fsSL https://deno.land/install.sh | sh" >&2
  exit 1
fi

# Source .env for KANBANFLOW_API_KEY
if [ -f "$SERVER_DIR/.env" ]; then
  set -a
  # shellcheck disable=SC1091
  source "$SERVER_DIR/.env"
  set +a
fi

if [ -z "${KANBANFLOW_API_KEY:-}" ] || [ "$KANBANFLOW_API_KEY" = "REPLACE_ME_WITH_YOUR_API_TOKEN" ]; then
  echo "Error: KANBANFLOW_API_KEY is not set or is still the placeholder value" >&2
  echo "Edit $SERVER_DIR/.env and set your KanbanFlow API token" >&2
  exit 1
fi

exec deno run --allow-net --allow-env "$SERVER_DIR/src/main.ts"
