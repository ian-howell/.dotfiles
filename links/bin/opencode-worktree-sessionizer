#!/usr/bin/env bash

set -euo pipefail

log_file="${TMPDIR:-/tmp}/opencode-worktree-sessionizer.log"
log() {
  if [ -z "${OPENCODE_WORKTREE_DEBUG:-}" ]; then
    return
  fi
  printf '%s %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$*" >>"$log_file"
}

slugify() {
  printf '%s' "$1" |
    tr '[:upper:]' '[:lower:]' |
    sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//'
}

sanitize_session_name() {
  local name="$1"
  name=$(printf '%s' "$name" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9_-]+/-/g')
  name=$(printf '%s' "$name" | sed -E 's/^-+//; s/-+$//')
  name=${name##.}
  printf '%s' "$name"
}

fail() {
  local message="$1"
  log "$message"
  echo "$message" >&2
  if [ -n "${TMUX:-}" ]; then
    tmux display-message -d 5000 "$message"
  fi
  exit 1
}

if [ -z "${TMUX:-}" ]; then
  fail "Error: tmux is not running"
fi

log "starting"
current_path=$(tmux display-message -p "#{pane_current_path}")
log "current_path=$current_path"
repo_root=$(git -C "$current_path" rev-parse --path-format=absolute --git-common-dir 2>/dev/null | xargs -r dirname 2>/dev/null)
log "repo_root=$repo_root"
if [ -z "$repo_root" ]; then
  fail "Error: not in a git repository"
fi

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
log "script_dir=$script_dir"
opencode_worktree="$script_dir/opencode-worktree"
if [ ! -x "$opencode_worktree" ]; then
  fail "Error: opencode-worktree not found at $opencode_worktree"
fi
log "path=$PATH"

task="${1:-}"
if [ -z "$task" ]; then
  if command -v gum >/dev/null 2>&1; then
    task=$(gum input --prompt "Task: " --placeholder "install gum")
  else
    read -r -p "Task: " task </dev/tty
  fi
fi

task=${task//$'\n'/}
task=${task//$'\r'/}
if [ -z "$task" ]; then
  log "empty task; exiting"
  exit 0
fi

slug=$(slugify "$task")
log "task=$task slug=$slug"
if [ -z "$slug" ]; then
  fail "Error: task slug is empty"
fi

repo_name=$(basename "$repo_root")
session_name=$(sanitize_session_name "${repo_name}-${slug}")
if [ -z "$session_name" ]; then
  fail "Error: session name is empty"
fi

if tmux has-session -t "$session_name" 2>/dev/null; then
log "session exists: $session_name"
  tmux switch-client -t "$session_name"
  exit 0
fi

log "creating session: $session_name"
if ! tmux new-session -d -s "$session_name" -c "$repo_root"; then
  fail "Error: failed to create tmux session"
fi

if ! tmux set-environment -t "$session_name" PATH "$PATH"; then
  fail "Error: failed to set PATH for session"
fi

worktree_path=$($opencode_worktree "$task" "$repo_root")
if [ -z "$worktree_path" ] || [ ! -d "$worktree_path" ]; then
  fail "Error: failed to create worktree"
fi

log "worktree_path=$worktree_path"

cmd_string="cd $(printf '%q' "$worktree_path")"
log "session command: $cmd_string"

if ! tmux send-keys -t "$session_name" "$cmd_string" C-m; then
  fail "Error: failed to send command to session"
fi

if ! tmux has-session -t "$session_name" 2>/dev/null; then
  fail "Error: tmux session failed to start"
fi

tmux switch-client -t "$session_name"
