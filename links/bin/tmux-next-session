#!/usr/bin/env bash

set -euo pipefail

if [[ -z "${TMUX:-}" ]]; then
    printf '%s\n' "Error: not running inside tmux." >&2
    exit 1
fi

src_session=$(tmux display-message -p '#S')
cwd=$(tmux display-message -p '#{pane_current_path}')
timestamp=$(date +%Y%m%d-%H%M%S)
cmd=()

# Sessions created by this script store their root name in a tmux session
# option so nested sessions remain siblings of the same root. We use
# @tmux_next_session_root to avoid guessing which segment is the root.
# - If the option exists on the current session, it is the root.
# - If it is missing, the current session name is treated as the root.
root_prefix=${src_session}
root_option=$(tmux show-option -qv -t "${src_session}" @tmux_next_session_root 2>/dev/null || true)
if [[ -n "${root_option}" ]]; then
    root_prefix=${root_option}
fi

if [[ $# -gt 0 ]]; then
    if [[ "$1" == "--" ]]; then
        shift
    fi
    cmd+=("$@")
fi

if [[ ${#cmd[@]} -gt 0 ]]; then
    suffix=${cmd[0]##*/}
else
    suffix=${SHELL##*/}
fi
suffix=${suffix//:/-}
suffix=${suffix// /-}
new_session="${root_prefix}-${suffix}"

if tmux has-session -t "${new_session}" 2>/dev/null; then
    tmux switch-client -t "${new_session}"
    exit 0
fi

tmp_window_name="__tmux_dup_tmp_${timestamp}"
tmp_window_id=$(tmux new-session -d -s "${new_session}" -n "${tmp_window_name}" -c "${cwd}" -P -F '#{window_id}')
tmux set-option -t "${new_session}" @tmux_next_session_root "${root_prefix}"
if [[ ${#cmd[@]} -gt 0 ]]; then
    tmux new-window -d -t "${new_session}" -c "${cwd}" -n "${new_session}" -- "${cmd[@]}"
else
    tmux new-window -d -t "${new_session}" -c "${cwd}" -n "${new_session}"
fi
tmux kill-window -t "${tmp_window_id}"

tmux switch-client -t "${new_session}"
